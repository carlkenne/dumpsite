<!DOCTYPE html>
<!--[if IEMobile 7 ]>    <html class="no-js iem7"> <![endif]-->
<!--[if (gt IEMobile 7)|!(IEMobile)]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <title>BeachStats</title>
        <meta name="description" content="">
        <meta name="HandheldFriendly" content="True">
        <meta name="MobileOptimized" content="320">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="cleartype" content="on">
        <link rel="apple-touch-icon-precomposed" sizes="144x144" href="img/touch/apple-touch-icon-144x144-precomposed.png">
        <link rel="apple-touch-icon-precomposed" sizes="114x114" href="img/touch/apple-touch-icon-114x114-precomposed.png">
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="img/touch/apple-touch-icon-72x72-precomposed.png">
        <link rel="apple-touch-icon-precomposed" href="img/touch/apple-touch-icon-57x57-precomposed.png">
        <link rel="shortcut icon" href="img/touch/apple-touch-icon.png">

        <!-- Tile icon for Win8 (144x144 + tile color) -->
        <meta name="msapplication-TileImage" content="img/touch/apple-touch-icon-144x144-precomposed.png">
        <meta name="msapplication-TileColor" content="#222222">


        <!-- For iOS web apps. Delete if not needed. https://github.com/h5bp/mobile-boilerplate/issues/94 -->
        <!--
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <meta name="apple-mobile-web-app-title" content="">
        -->

        <!-- This script prevents links from opening in Mobile Safari. https://gist.github.com/1042026 -->
        <!--
        <script>(function(a,b,c){if(c in b&&b[c]){var d,e=a.location,f=/^(a|html)$/i;a.addEventListener("click",function(a){d=a.target;while(!f.test(d.nodeName))d=d.parentNode;"href"in d&&(d.href.indexOf("http")||~d.href.indexOf(e.host))&&(a.preventDefault(),e.href=d.href)},!1)}})(document,window.navigator,"standalone")</script>
        -->

        <link rel="stylesheet" href="css/normalize.css">
        <link rel="stylesheet" href="css/main.css">
        <link rel="stylesheet" href="css/beach.css">
        <script src="js/vendor/modernizr-2.6.2.min.js"></script>
        <script src="js/vendor/RxJS-master/dist/rx.all.js"></script>
        <script src="js/vendor/react-0.10.0/build/react.js"></script>
        <script src="js/vendor/hammer.js-1.1.3/hammer.min.js"></script>

    </head>
    <body>
        <div class="court columns">
            <canvas id="canvas" width="600" height="600"></canvas>
            <div id="leftCourt" class="courtSection"> Team A </div>
            <div id="rightCourt" class="courtSection"> Team B </div>
            <div id="leftOut">  </div>
            <div id="rightOut">  </div>
            <div id="topOut">  </div>
            <div id="bottomOut">  </div>
            <div id="netOut">  </div>
        </div>
        <!-- Add your site or application content here -->


        <script src="js/vendor/zepto.min.js"></script>
        <script src="js/helper.js"></script>
        <script type="text/javascript">
            var clientRect;
            var canvas = document.querySelector("#canvas");

            window.addEventListener("DOMContentLoaded", function(){
                canvas.width = document.body.clientWidth;
                canvas.height = document.body.clientHeight;
                clientRect = canvas.getBoundingClientRect();
            });

            function intersects(hit){
                var all = document.querySelectorAll(".court > div:not(#" + hit.srcId + ")");
                for(i = 0; i < all.length; i++) {
                    if(all[i].getBoundingClientRect().left < hit.to.clientX &&
                    all[i].getBoundingClientRect().right > hit.to.clientX &&
                    all[i].getBoundingClientRect().top < hit.to.clientY &&
                    all[i].getBoundingClientRect().bottom > hit.to.clientY){
                        return all[i];
                    }
                }
            }

            function clearHighlight(except) {
                var all = document.querySelectorAll(".court > div");
                for(i = 0; i < all.length; i++) {
                    if(all[i].id !== except) {
                        all[i].classList.remove("highlight");
                    }
                }
            }

            var dragTarget = document.querySelector('.court');

             // Get the three major events
            var mouseup = Rx.Observable.fromEvent(dragTarget, 'mouseup');
            var mousemove = Rx.Observable.fromEvent(document, 'mousemove');
            var mousedown = Rx.Observable.fromEvent(dragTarget, 'mousedown');

            mousedown.flatMap(function (ev) {
                dragStart(ev);

                return mousemove.takeUntil(mouseup)
                        .map(function(mm){
                    (mm.preventDefault) ? mm.preventDefault() : event.returnValue = false;
                    return mm;
                }).do( function(e){}, function(e){}, dragEnd);
            }).subscribe(dragging);

            var hits = [];
            var draggingHit;
            function dragStart(ev){
                var src = ev.srcElement.id
                var start = transformPoint(ev);
                draggingHit = {
                    radius: 25,
                    from: start,
                    to: start,
                    srcId: src,
                    strokeStyle: src == "leftCourt" ? "255,0,0" : "0,0,255"
                }
                hits.push(draggingHit);
            }

            function dragging(ev){
                draggingHit.to = transformPoint(ev);

                if(el = intersects(draggingHit)){
                   el.classList.add("highlight");
                   clearHighlight(el.id);
                } else {
                   clearHighlight();
                }

                drawHits();
            }

            function dragEnd(){
                draggingHit.complete = true;
                draggingHit = undefined;
                drawHits();
                clearHighlight();
            }

            function transformPoint(point){
                return {clientX: point.clientX - canvas.getBoundingClientRect().left,
                        clientY: point.clientY - canvas.getBoundingClientRect().top
                }
            }

            function drawHits(){
                var ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                for(var i = 0; i < hits.length; i++){
                    if(hits[i].complete){
                        drawHit(ctx, hits[i]);
                    } else {
                        drawLine(ctx, hits[i]);
                    }
                }
            }

            function drawLine(ctx, hit) {
                ctx.beginPath();
                ctx.moveTo(hit.from.clientX, hit.from.clientY);
                ctx.lineTo(hit.to.clientX, hit.to.clientY);
                ctx.closePath();
                ctx.strokeStyle = "rgba("+ hit.strokeStyle + ", 0.3)";
                ctx.stroke();
            }

            function drawHit(ctx, hit) {
                ctx.beginPath();
                ctx.arc(hit.to.clientX, hit.to.clientY, hit.radius, 0, 2 * Math.PI, false);
                ctx.closePath();
                ctx.fillStyle = "rgba("+ hit.strokeStyle + ", 0.3)";
                ctx.fill();
            }
        </script>
    </body>
</html>
